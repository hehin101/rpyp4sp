from __future__ import print_function
import pytest

import os

from rpyp4sp.rpyjson import loads
from rpyp4sp.context import Context
from rpyp4sp import p4specast, objects, interp, rpyjson

def load():
    currfile = os.path.abspath(__file__)
    basedir = os.path.dirname(os.path.dirname(os.path.dirname(currfile)))
    fn = os.path.join(basedir, "ast.json")
    with open(fn) as f:
        value = loads(f.read())
    defs = []
    for i, d in enumerate(value.value_array()):
        defs.append(p4specast.Def.fromjson(d))
    return defs

def make_context(loaded=[]):
    if loaded:
        return loaded[0]
    spec = load()
    ctx = Context('dummy')
    ctx.load_spec(spec)
    loaded.append(ctx)
    return ctx


def test_load_spec():
    ctx = make_context()
    assert 'Prog_ok' in ctx.glbl.renv
    assert 'is_fbitt' in ctx.glbl.fenv
    print(ctx.glbl.fenv["is_fbitt"])

def test_is_fbitt():
    # dec $is_fbitt(typ) : bool
    #     hint(show % IS FBIT_T)
    # def $is_fbitt(FBitT _) = true
    # def $is_fbitt(typ) = false
    #   -- otherwise
    ctx = make_context()

    # returns False
    func = ctx.glbl.fenv["is_fbitt"]
    arg = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(left=p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), right=p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 432, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(left=p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), right=p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), []))
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg])
    assert value.get_bool() == False

    noposition = p4specast.Position('', 0, 0)
    noregion = p4specast.Region(noposition, noposition)

    arg = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitT', noregion)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('BinE', noregion)], [], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('PLUS', noregion)]]), [], 1, p4specast.VarT(p4specast.Id('binop', noregion), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', noregion)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', noregion)], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 3, p4specast.VarT(p4specast.Id('num', noregion), []))], 4, p4specast.VarT(p4specast.Id('expr', noregion), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', noregion)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', noregion)], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 6, p4specast.VarT(p4specast.Id('num', noregion), []))], 7, p4specast.VarT(p4specast.Id('expr', noregion), []))], 8, p4specast.VarT(p4specast.Id('expr', noregion), []))], 9, p4specast.VarT(p4specast.Id('type', noregion), []))
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg])

def test_coerce_binary():
    arg0 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 99, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 100, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 101, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 102, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 103, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))
    arg1 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 110, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 111, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 112, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 113, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 114, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))
    expected = objects.OptV(objects.TupleV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 99, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 100, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 101, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 102, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 103, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 110, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 111, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 112, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 113, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 114, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))], 131, p4specast.TupleT([p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 44, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 44, 13))), []), p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 44, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 44, 13))), [])])), 132, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/4d2-typing-subtyping.watsup', 379, 38), p4specast.Position('spec/4d2-typing-subtyping.watsup', 379, 44))), []), p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/4d2-typing-subtyping.watsup', 379, 46), p4specast.Position('spec/4d2-typing-subtyping.watsup', 379, 52))), [])]), p4specast.Opt()))

    ctx = make_context()
    func = ctx.glbl.fenv["coerce_binary"]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg0, arg1])
    assert value.eq(expected)

def test_reduce_senums_binary():
    arg0 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 99, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 100, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 101, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 102, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 103, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))
    arg1 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 110, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 111, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 112, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 113, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 114, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))
    arg2 = objects.FuncV(p4specast.Id('compatible_plusminusmult', p4specast.Region(p4specast.Position('spec/4e-typing-expr.watsup', 173, 84), p4specast.Position('spec/4e-typing-expr.watsup', 173, 108))), 137, p4specast.FuncT())
    expected = objects.OptV(objects.TupleV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 99, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 100, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 101, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 102, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 103, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 110, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 111, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 112, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 113, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 114, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))], 161, p4specast.TupleT([p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 44, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 44, 13))), []), p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 44, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 44, 13))), [])])), 162, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/4d2-typing-subtyping.watsup', 330, 81), p4specast.Position('spec/4d2-typing-subtyping.watsup', 330, 87))), []), p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/4d2-typing-subtyping.watsup', 330, 89), p4specast.Position('spec/4d2-typing-subtyping.watsup', 330, 95))), [])]), p4specast.Opt()))

    ctx = make_context()
    func = ctx.glbl.fenv["reduce_senums_binary"]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg0, arg1, arg2])

    assert value.eq(expected)

@pytest.mark.xfail(msg="missing support for tparams")
def test_empty_context():
    ctx = make_context()
    func = ctx.glbl.fenv["empty_context"]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [])


def test_bin_plus():
    ctx = make_context()
    func = ctx.glbl.fenv["bin_plus"]
    arg0 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 13, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 13, 8)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 220, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), []))

    arg1 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 13, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 13, 8)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 231, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), []))

    res = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 13, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 13, 8)))], []]), [objects.NumV.fromstr('8', 'Int', 240, p4specast.NumT(p4specast.IntT()))], 241, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), []))
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg0, arg1])
    assert value.eq(res)

def test_cast_int():
    args = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 38, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 38, 9)))], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT()))], 248, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.NumV.fromstr('10', 'Int', 10, p4specast.NumT(p4specast.IntT()))]
    name = "cast_int'"
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, args)
    expected = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 15, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 15, 9)))], [], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT())), objects.NumV.fromstr('10', 'Int', 370, p4specast.NumT(p4specast.IntT()))], 371, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), []))
    assert value.eq(expected)

def test_find_styp():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('GLOBAL', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 5, 16), p4specast.Position('spec/4a1-typing-context.watsup', 5, 22)))]]), [], 52, p4specast.VarT(p4specast.Id('cursor', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 5, 7), p4specast.Position('spec/4a1-typing-context.watsup', 5, 13))), [])), objects.StructV([(p4specast.AtomT('GLOBAL', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 56, 4), p4specast.Position('spec/4a1-typing-context.watsup', 56, 10))), objects.StructV([(p4specast.AtomT('CDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 16, 4), p4specast.Position('spec/4a1-typing-context.watsup', 16, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 25, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 26, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('TDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 17, 4), p4specast.Position('spec/4a1-typing-context.watsup', 17, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 27, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 28, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 18, 4), p4specast.Position('spec/4a1-typing-context.watsup', 18, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 29, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 30, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FRAME', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 19, 4), p4specast.Position('spec/4a1-typing-context.watsup', 19, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))]]), [objects.ListV([objects.CaseV(p4specast.MixOp([[], [p4specast.AtomT('->', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))], []]), [objects.TextV('b', 0, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [])), objects.CaseV(p4specast.MixOp([[], [], [], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 38, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 38, 9)))], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT()))], 248, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NO', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 90, 15), p4specast.Position('spec/1a-syntax-el.watsup', 90, 17)))]]), [], 374, p4specast.VarT(p4specast.Id('dir', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 90, 7), p4specast.Position('spec/1a-syntax-el.watsup', 90, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 375, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), [])), objects.OptV(objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 15, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 15, 9)))], [], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT())), objects.NumV.fromstr('10', 'Int', 370, p4specast.NumT(p4specast.IntT()))], 371, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), [])), 376, p4specast.IterT(p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2e-runtime-env.watsup', 11, 26), p4specast.Position('spec/2e-runtime-env.watsup', 11, 29))), []), p4specast.Opt()))], 377, p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/2e-runtime-env.watsup', 11, 7), p4specast.Position('spec/2e-runtime-env.watsup', 11, 11))), []))], 394, p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 25), p4specast.Position('spec/4a1-typing-context.watsup', 159, 27))), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 29), p4specast.Position('spec/4a1-typing-context.watsup', 159, 33))), [])]))], 393, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 25), p4specast.Position('spec/4a1-typing-context.watsup', 159, 27))), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 29), p4specast.Position('spec/4a1-typing-context.watsup', 159, 33))), [])]), p4specast.List()))], 395, p4specast.VarT(p4specast.Id('map', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 25), p4specast.Position('spec/4a1-typing-context.watsup', 159, 27))), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 29), p4specast.Position('spec/4a1-typing-context.watsup', 159, 33))), [])])))], 396, p4specast.VarT(p4specast.Id('glayer', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 56, 11), p4specast.Position('spec/4a1-typing-context.watsup', 56, 17))), []))), (p4specast.AtomT('BLOCK', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 57, 4), p4specast.Position('spec/4a1-typing-context.watsup', 57, 9))), objects.StructV([(p4specast.AtomT('ID', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 26, 4), p4specast.Position('spec/4a1-typing-context.watsup', 26, 6))), objects.TextV('', 34, p4specast.TextT())), (p4specast.AtomT('KIND', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 27, 4), p4specast.Position('spec/4a1-typing-context.watsup', 27, 8))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('EMPTY', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 23, 15), p4specast.Position('spec/4a1-typing-context.watsup', 23, 20)))]]), [], 35, p4specast.VarT(p4specast.Id('bkind', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 23, 7), p4specast.Position('spec/4a1-typing-context.watsup', 23, 12))), []))), (p4specast.AtomT('TDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 28, 4), p4specast.Position('spec/4a1-typing-context.watsup', 28, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 36, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 37, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 29, 4), p4specast.Position('spec/4a1-typing-context.watsup', 29, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 38, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 39, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FRAME', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 30, 4), p4specast.Position('spec/4a1-typing-context.watsup', 30, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 40, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 41, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])])))], 42, p4specast.VarT(p4specast.Id('blayer', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 25, 7), p4specast.Position('spec/4a1-typing-context.watsup', 25, 13))), []))), (p4specast.AtomT('LOCAL', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 58, 4), p4specast.Position('spec/4a1-typing-context.watsup', 58, 9))), objects.StructV([(p4specast.AtomT('ID', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 46, 4), p4specast.Position('spec/4a1-typing-context.watsup', 46, 6))), objects.TextV('', 43, p4specast.TextT())), (p4specast.AtomT('KIND', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 47, 4), p4specast.Position('spec/4a1-typing-context.watsup', 47, 8))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('EMPTY', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 35, 4), p4specast.Position('spec/4a1-typing-context.watsup', 35, 9)))]]), [], 44, p4specast.VarT(p4specast.Id('lkind', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 34, 7), p4specast.Position('spec/4a1-typing-context.watsup', 34, 12))), []))), (p4specast.AtomT('TDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 48, 4), p4specast.Position('spec/4a1-typing-context.watsup', 48, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 45, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 46, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FRAMES', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 49, 4), p4specast.Position('spec/4a1-typing-context.watsup', 49, 10))), objects.ListV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 47, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 48, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))], 49, p4specast.IterT(p4specast.VarT(p4specast.Id('map', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 23), p4specast.Position('spec/0-aux.watsup', 108, 27))), [p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 84, 29), p4specast.Position('spec/4a1-typing-context.watsup', 84, 31))), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 84, 33), p4specast.Position('spec/4a1-typing-context.watsup', 84, 37))), [])]), p4specast.List())))], 50, p4specast.VarT(p4specast.Id('llayer', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 45, 7), p4specast.Position('spec/4a1-typing-context.watsup', 45, 13))), [])))], 397, p4specast.VarT(p4specast.Id('context', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 60, 8), p4specast.Position('spec/4a1-typing-context.watsup', 60, 15))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('CURRENT', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))], []]), [objects.TextV('b', 15, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))], 16, p4specast.VarT(p4specast.Id('name', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))]
    expected = objects.OptV(objects.CaseV(p4specast.MixOp([[], [], [], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 38, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 38, 9)))], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT()))], 248, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NO', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 90, 15), p4specast.Position('spec/1a-syntax-el.watsup', 90, 17)))]]), [], 374, p4specast.VarT(p4specast.Id('dir', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 90, 7), p4specast.Position('spec/1a-syntax-el.watsup', 90, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 375, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), [])), objects.OptV(objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 15, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 15, 9)))], [], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT())), objects.NumV.fromstr('10', 'Int', 370, p4specast.NumT(p4specast.IntT()))], 371, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), [])), 376, p4specast.IterT(p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2e-runtime-env.watsup', 11, 26), p4specast.Position('spec/2e-runtime-env.watsup', 11, 29))), []), p4specast.Opt()))], 377, p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/2e-runtime-env.watsup', 11, 7), p4specast.Position('spec/2e-runtime-env.watsup', 11, 11))), [])), 429, p4specast.IterT(p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 286, 54), p4specast.Position('spec/4a1-typing-context.watsup', 286, 58))), []), p4specast.Opt()))
    name = 'find_styp'
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(expected)

def test_text_exp():
    exp = p4specast.TextE('main')
    exp.typ = p4specast.TextT()
    ctx, value = interp.eval_exp(None, exp)
    expected = objects.TextV('main', typ=p4specast.TextT())
    assert value.eq(expected)

def test_upcast():
    typ = p4specast.VarT(p4specast.Id('typ', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 19), p4specast.Position('spec/3-syntax-il.watsup', 123, 22))), [])
    value = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], -1, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), []))
    ctx = make_context()
    ctx, res = interp.upcast(ctx, typ, value)
    assert res.eq(value)


def test_assign_exp():
    # TODO: incomplete, what do we actually expect?
    ctx = Context('dummy')
    exp = p4specast.IterE(p4specast.VarE(p4specast.Id('text', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 32, 17), p4specast.Position('spec/0-aux.watsup', 32, 20)))), p4specast.List(), [p4specast.Var(id=p4specast.Id('text', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 32, 17), p4specast.Position('spec/0-aux.watsup', 32, 20))), typ=p4specast.TextT(), iter=[])])
    value = objects.ListV([], 1540, p4specast.IterT(p4specast.TextT(), p4specast.List()))
    ctx_returned = interp.assign_exp(ctx, exp, value)
    print(ctx_returned)

def test_concat_text():
    input_values = [objects.ListV([objects.TextV('CounterType', 254, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [])), objects.TextV('.', 7650, p4specast.TextT()), objects.TextV('packets_and_bytes', 257, p4specast.VarT(p4specast.Id('member', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))], 7651, p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.List()))]
    name = 'concat_text'
    expected = objects.TextV('CounterType.packets_and_bytes', 7689, p4specast.TextT())

    ctx = make_context()
    func = ctx.glbl.fenv[name]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(expected)

@pytest.mark.xfail(msg='missing builtin fresh_tid')
def test_conse_fresh_tids():
    name = 'fresh_tids'
    input_values = [objects.NumV.fromstr('1', 'Nat', 8286, p4specast.NumT(p4specast.NatT()))]
    res = objects.ListV([objects.TextV('FRESH__0', 8289, p4specast.VarT(p4specast.Id('tid', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))], 8295, p4specast.IterT(p4specast.VarT(p4specast.Id('tid', p4specast.Region(p4specast.Position('spec/2a-runtime-domain.watsup', 13, 19), p4specast.Position('spec/2a-runtime-domain.watsup', 13, 22))), []), p4specast.List()))
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)

def test_check_arity():
    name = 'check_arity'
    input_values = [objects.ListV([], 4811, p4specast.IterT(p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.Opt()), p4specast.List())), objects.ListV([], 4812, p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.List()))]
    res = objects.BoolV(True, 4819, p4specast.BoolT())
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)

    input_values = [objects.ListV([objects.OptV(None, 3943, p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.Opt()))], 3944, p4specast.IterT(p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.Opt()), p4specast.List())), objects.ListV([objects.TextV('p', 92, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))], 3945, p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.List()))]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)


    res = objects.BoolV(False, 4803, p4specast.BoolT())
    name = 'check_arity_more'
    func = ctx.glbl.fenv[name]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)

def test_eval_num_expr():
    exp = p4specast.NumE.fromstr('0', 'Nat')
    exp.typ = p4specast.NumT(p4specast.NatT())
    _, value = interp.eval_exp(None, exp)
    assert value.eq(objects.NumV.fromstr('0', 'Nat'))


def iter_all(fn):
    with open(fn, 'r') as f:
        for line in f:
            if not line.startswith('{'):
                continue
            callspec = rpyjson.loads(line)
            what = callspec['calltype'].value_string()
            args = callspec['inputs']
            input_values = [objects.BaseV.fromjson(arg) for arg in args]
            if what == 'function':
                res_value = objects.BaseV.fromjson(callspec['result'])
                yield "function", callspec['name'].value_string(), input_values, res_value
            elif what == 'relation':
                res_values = [objects.BaseV.fromjson(rv) for rv in callspec['results']]
                yield "relation", callspec['name'].value_string(), input_values, res_values
            else:
                assert 0

def test_all():
    # load test cases from line-based json file
    # check if file exists
    if not os.path.exists(os.path.join(os.path.dirname(__file__), 'interp_tests.json')):
        assert False
    ctx = make_context()
    passed = 0
    failed = 0
    error = 0
    for calltype, name, input_values, res in iter_all(os.path.join(os.path.dirname(__file__), 'interp_tests.json')):
        if calltype == "function":
            if name not in ctx.glbl.fenv:
                continue
            func = ctx.glbl.fenv[name]
            try:
                _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
                if not value.eq(res):
                    failed += 1
                    print("Function test failed:", name, value, res)
                else:
                    passed += 1
                    print("Function test passed:", name)
            except Exception as e:
                #import pdb; pdb.xpm()
                error += 1
                print("Function test exception:", name, e)
                continue
        if calltype == "relation":
            try:
                _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
                if len(values) != len(res):
                    failed += 1
                    print("Relation test wrong number of results", name, len(values), len(res))
                else:
                    for resval, resval_exp in zip(values, res):
                        if not resval.eq(resval_exp):
                            failed += 1
                            print("Relation test failed:", name, resval, resval_exp)
                        else:
                            passed += 1
                            print("Relation test passed:", name)
            except Exception as e:
                #import pdb; pdb.xpm()
                error += 1
                print("Relation test exception:", name, e)
                continue
    print("PASSED:", passed)
    print("FAILED", failed)
    print("ERROR ", error)
