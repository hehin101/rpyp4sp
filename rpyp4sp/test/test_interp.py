from __future__ import print_function
import pytest

import os

from rpyp4sp.rpyjson import loads
from rpyp4sp.context import Context
from rpyp4sp import p4specast, objects, interp, rpyjson

currfile = os.path.abspath(__file__)
basedir = os.path.dirname(os.path.dirname(os.path.dirname(currfile)))
ASTFN = os.path.join(basedir, "ast.json")

def load():
    with open(ASTFN) as f:
        value = loads(f.read())
    defs = []
    for i, d in enumerate(value.value_array()):
        defs.append(p4specast.Def.fromjson(d))
    return defs

def make_context(loaded=[]):
    if loaded:
        return loaded[0]
    spec = load()
    ctx = Context('dummy')
    ctx.load_spec(spec)
    loaded.append(ctx)
    return ctx


def test_load_spec():
    ctx = make_context()
    assert 'Prog_ok' in ctx.glbl.renv
    assert 'is_fbitt' in ctx.glbl.fenv
    print(ctx.glbl.fenv["is_fbitt"])

def test_subtyp_nat():
    typ = p4specast.NumT(p4specast.NatT())
    value = objects.NumV.fromstr('32', 'Int', 3, p4specast.NumT(p4specast.IntT()))
    res = interp.subtyp(None, typ, value)
    assert res is True

def test_downcast_nat():
    typ = p4specast.NumT(p4specast.NatT())
    value = objects.NumV.fromstr('32', 'Int', 3, p4specast.NumT(p4specast.IntT()))
    _, res = interp.downcast(None, typ, value)
    assert res.what == 'Nat'

def test_upcast_list():
    typ = p4specast.IterT(p4specast.VarT(p4specast.Id('paramIL', p4specast.Region.line_span('spec/4g-typing-decl.watsup', 787, 32, 39)), []), p4specast.List())
    value = objects.ListV([], -1, p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 18, 9, 17)), []), p4specast.List()))
    _, res = interp.upcast(None, typ, value)
    assert res is value

def test_eval_arg():
    arg = p4specast.DefA(p4specast.Id('compatible_plusminusmult', p4specast.Region.line_span('spec/4e-typing-expr.watsup', 173, 84, 108)))
    ctx = make_context()
    ctx, res = interp.eval_arg(ctx, arg)

def test_is_fbitt():
    # dec $is_fbitt(typ) : bool
    #     hint(show % IS FBIT_T)
    # def $is_fbitt(FBitT _) = true
    # def $is_fbitt(typ) = false
    #   -- otherwise
    ctx = make_context()

    # returns False
    func = ctx.glbl.fenv["is_fbitt"]
    arg = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(left=p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), right=p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 432, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(left=p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), right=p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), []))
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg])
    assert value.get_bool() == False

    noposition = p4specast.Position('', 0, 0)
    noregion = p4specast.Region(noposition, noposition)

    arg = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitT', noregion)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('BinE', noregion)], [], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('PLUS', noregion)]]), [], 1, p4specast.VarT(p4specast.Id('binop', noregion), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', noregion)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', noregion)], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 3, p4specast.VarT(p4specast.Id('num', noregion), []))], 4, p4specast.VarT(p4specast.Id('expr', noregion), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', noregion)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', noregion)], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 6, p4specast.VarT(p4specast.Id('num', noregion), []))], 7, p4specast.VarT(p4specast.Id('expr', noregion), []))], 8, p4specast.VarT(p4specast.Id('expr', noregion), []))], 9, p4specast.VarT(p4specast.Id('type', noregion), []))
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg])

def test_coerce_binary():
    arg0 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 99, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 100, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 101, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 102, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 103, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))
    arg1 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 110, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 111, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 112, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 113, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 114, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))
    expected = objects.OptV(objects.TupleV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 99, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 100, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 101, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 102, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 103, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 110, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 111, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 112, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 113, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 114, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))], 131, p4specast.TupleT([p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 44, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 44, 13))), []), p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 44, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 44, 13))), [])])), 132, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/4d2-typing-subtyping.watsup', 379, 38), p4specast.Position('spec/4d2-typing-subtyping.watsup', 379, 44))), []), p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/4d2-typing-subtyping.watsup', 379, 46), p4specast.Position('spec/4d2-typing-subtyping.watsup', 379, 52))), [])]), p4specast.Opt()))

    ctx = make_context()
    func = ctx.glbl.fenv["coerce_binary"]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg0, arg1])
    assert value.eq(expected)

def test_reduce_senums_binary():
    arg0 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 99, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 100, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 101, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 102, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 103, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))
    arg1 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 110, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 111, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 112, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 113, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 114, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))
    arg2 = objects.FuncV(p4specast.Id('compatible_plusminusmult', p4specast.Region(p4specast.Position('spec/4e-typing-expr.watsup', 173, 84), p4specast.Position('spec/4e-typing-expr.watsup', 173, 108))), 137, p4specast.FuncT())
    expected = objects.OptV(objects.TupleV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 99, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 100, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 101, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 102, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 103, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NumE', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 128, 4), p4specast.Position('spec/3-syntax-il.watsup', 128, 8)))], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('INT', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 9, 4), p4specast.Position('spec/1a-syntax-el.watsup', 9, 7)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 110, p4specast.VarT(p4specast.Id('num', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 8, 7), p4specast.Position('spec/1a-syntax-el.watsup', 8, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('(', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 18), p4specast.Position('spec/3-syntax-il.watsup', 123, 19)))], [p4specast.AtomT(';', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 22), p4specast.Position('spec/3-syntax-il.watsup', 123, 23)))], [p4specast.AtomT(')', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 27), p4specast.Position('spec/3-syntax-il.watsup', 123, 28)))]]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], 111, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 112, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), []))], 113, p4specast.VarT(p4specast.Id('annotIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 7), p4specast.Position('spec/3-syntax-il.watsup', 123, 14))), []))], 114, p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 124, 7), p4specast.Position('spec/3-syntax-il.watsup', 124, 13))), []))], 161, p4specast.TupleT([p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 44, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 44, 13))), []), p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 44, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 44, 13))), [])])), 162, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/4d2-typing-subtyping.watsup', 330, 81), p4specast.Position('spec/4d2-typing-subtyping.watsup', 330, 87))), []), p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/4d2-typing-subtyping.watsup', 330, 89), p4specast.Position('spec/4d2-typing-subtyping.watsup', 330, 95))), [])]), p4specast.Opt()))

    ctx = make_context()
    func = ctx.glbl.fenv["reduce_senums_binary"]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg0, arg1, arg2])

    assert value.eq(expected)

def test_empty_context():
    ctx = make_context()
    func = ctx.glbl.fenv["empty_context"]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [])


def test_bin_plus():
    ctx = make_context()
    func = ctx.glbl.fenv["bin_plus"]
    arg0 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 13, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 13, 8)))], []]), [objects.NumV.fromstr('5', 'Int', 2, p4specast.NumT(p4specast.IntT()))], 220, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), []))

    arg1 = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 13, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 13, 8)))], []]), [objects.NumV.fromstr('3', 'Int', 5, p4specast.NumT(p4specast.IntT()))], 231, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), []))

    res = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 13, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 13, 8)))], []]), [objects.NumV.fromstr('8', 'Int', 240, p4specast.NumT(p4specast.IntT()))], 241, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), []))
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, [arg0, arg1])
    assert value.eq(res)

def test_cast_int():
    args = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 38, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 38, 9)))], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT()))], 248, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.NumV.fromstr('10', 'Int', 10, p4specast.NumT(p4specast.IntT()))]
    name = "cast_int'"
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, args)
    expected = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 15, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 15, 9)))], [], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT())), objects.NumV.fromstr('10', 'Int', 370, p4specast.NumT(p4specast.IntT()))], 371, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), []))
    assert value.eq(expected)

def test_find_styp():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('GLOBAL', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 5, 16), p4specast.Position('spec/4a1-typing-context.watsup', 5, 22)))]]), [], 52, p4specast.VarT(p4specast.Id('cursor', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 5, 7), p4specast.Position('spec/4a1-typing-context.watsup', 5, 13))), [])), objects.StructV([(p4specast.AtomT('GLOBAL', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 56, 4), p4specast.Position('spec/4a1-typing-context.watsup', 56, 10))), objects.StructV([(p4specast.AtomT('CDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 16, 4), p4specast.Position('spec/4a1-typing-context.watsup', 16, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 25, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 26, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('TDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 17, 4), p4specast.Position('spec/4a1-typing-context.watsup', 17, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 27, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 28, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 18, 4), p4specast.Position('spec/4a1-typing-context.watsup', 18, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 29, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 30, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FRAME', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 19, 4), p4specast.Position('spec/4a1-typing-context.watsup', 19, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))]]), [objects.ListV([objects.CaseV(p4specast.MixOp([[], [p4specast.AtomT('->', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))], []]), [objects.TextV('b', 0, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [])), objects.CaseV(p4specast.MixOp([[], [], [], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 38, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 38, 9)))], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT()))], 248, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NO', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 90, 15), p4specast.Position('spec/1a-syntax-el.watsup', 90, 17)))]]), [], 374, p4specast.VarT(p4specast.Id('dir', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 90, 7), p4specast.Position('spec/1a-syntax-el.watsup', 90, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 375, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), [])), objects.OptV(objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 15, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 15, 9)))], [], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT())), objects.NumV.fromstr('10', 'Int', 370, p4specast.NumT(p4specast.IntT()))], 371, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), [])), 376, p4specast.IterT(p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2e-runtime-env.watsup', 11, 26), p4specast.Position('spec/2e-runtime-env.watsup', 11, 29))), []), p4specast.Opt()))], 377, p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/2e-runtime-env.watsup', 11, 7), p4specast.Position('spec/2e-runtime-env.watsup', 11, 11))), []))], 394, p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 25), p4specast.Position('spec/4a1-typing-context.watsup', 159, 27))), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 29), p4specast.Position('spec/4a1-typing-context.watsup', 159, 33))), [])]))], 393, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 25), p4specast.Position('spec/4a1-typing-context.watsup', 159, 27))), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 29), p4specast.Position('spec/4a1-typing-context.watsup', 159, 33))), [])]), p4specast.List()))], 395, p4specast.VarT(p4specast.Id('map', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 25), p4specast.Position('spec/4a1-typing-context.watsup', 159, 27))), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 159, 29), p4specast.Position('spec/4a1-typing-context.watsup', 159, 33))), [])])))], 396, p4specast.VarT(p4specast.Id('glayer', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 56, 11), p4specast.Position('spec/4a1-typing-context.watsup', 56, 17))), []))), (p4specast.AtomT('BLOCK', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 57, 4), p4specast.Position('spec/4a1-typing-context.watsup', 57, 9))), objects.StructV([(p4specast.AtomT('ID', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 26, 4), p4specast.Position('spec/4a1-typing-context.watsup', 26, 6))), objects.TextV('', 34, p4specast.TextT())), (p4specast.AtomT('KIND', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 27, 4), p4specast.Position('spec/4a1-typing-context.watsup', 27, 8))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('EMPTY', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 23, 15), p4specast.Position('spec/4a1-typing-context.watsup', 23, 20)))]]), [], 35, p4specast.VarT(p4specast.Id('bkind', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 23, 7), p4specast.Position('spec/4a1-typing-context.watsup', 23, 12))), []))), (p4specast.AtomT('TDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 28, 4), p4specast.Position('spec/4a1-typing-context.watsup', 28, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 36, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 37, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 29, 4), p4specast.Position('spec/4a1-typing-context.watsup', 29, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 38, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 39, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FRAME', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 30, 4), p4specast.Position('spec/4a1-typing-context.watsup', 30, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 40, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 41, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])])))], 42, p4specast.VarT(p4specast.Id('blayer', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 25, 7), p4specast.Position('spec/4a1-typing-context.watsup', 25, 13))), []))), (p4specast.AtomT('LOCAL', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 58, 4), p4specast.Position('spec/4a1-typing-context.watsup', 58, 9))), objects.StructV([(p4specast.AtomT('ID', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 46, 4), p4specast.Position('spec/4a1-typing-context.watsup', 46, 6))), objects.TextV('', 43, p4specast.TextT())), (p4specast.AtomT('KIND', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 47, 4), p4specast.Position('spec/4a1-typing-context.watsup', 47, 8))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('EMPTY', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 35, 4), p4specast.Position('spec/4a1-typing-context.watsup', 35, 9)))]]), [], 44, p4specast.VarT(p4specast.Id('lkind', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 34, 7), p4specast.Position('spec/4a1-typing-context.watsup', 34, 12))), []))), (p4specast.AtomT('TDENV', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 48, 4), p4specast.Position('spec/4a1-typing-context.watsup', 48, 9))), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 45, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 46, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))), (p4specast.AtomT('FRAMES', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 49, 4), p4specast.Position('spec/4a1-typing-context.watsup', 49, 10))), objects.ListV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 47, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])]), p4specast.List()))], 48, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('pair', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 106, 24), p4specast.Position('spec/0-aux.watsup', 106, 29))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 27), p4specast.Position('spec/0-aux.watsup', 108, 28))), []), p4specast.VarT(p4specast.Id('V', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 30), p4specast.Position('spec/0-aux.watsup', 108, 31))), [])])]))], 49, p4specast.IterT(p4specast.VarT(p4specast.Id('map', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 108, 23), p4specast.Position('spec/0-aux.watsup', 108, 27))), [p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 84, 29), p4specast.Position('spec/4a1-typing-context.watsup', 84, 31))), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 84, 33), p4specast.Position('spec/4a1-typing-context.watsup', 84, 37))), [])]), p4specast.List())))], 50, p4specast.VarT(p4specast.Id('llayer', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 45, 7), p4specast.Position('spec/4a1-typing-context.watsup', 45, 13))), [])))], 397, p4specast.VarT(p4specast.Id('context', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 60, 8), p4specast.Position('spec/4a1-typing-context.watsup', 60, 15))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('CURRENT', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))], []]), [objects.TextV('b', 15, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))], 16, p4specast.VarT(p4specast.Id('name', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))]
    expected = objects.OptV(objects.CaseV(p4specast.MixOp([[], [], [], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 38, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 38, 9)))], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT()))], 248, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NO', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 90, 15), p4specast.Position('spec/1a-syntax-el.watsup', 90, 17)))]]), [], 374, p4specast.VarT(p4specast.Id('dir', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 90, 7), p4specast.Position('spec/1a-syntax-el.watsup', 90, 10))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('LCTK', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 13), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 17)))]]), [], 375, p4specast.VarT(p4specast.Id('ctk', p4specast.Region(p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 7), p4specast.Position('spec/2f-runtime-ctk.watsup', 5, 10))), [])), objects.OptV(objects.CaseV(p4specast.MixOp([[p4specast.AtomT('FBitV', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 15, 4), p4specast.Position('spec/2b2-runtime-value.watsup', 15, 9)))], [], []]), [objects.NumV.fromstr('8', 'Nat', 247, p4specast.NumT(p4specast.NatT())), objects.NumV.fromstr('10', 'Int', 370, p4specast.NumT(p4specast.IntT()))], 371, p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2b2-runtime-value.watsup', 7, 7), p4specast.Position('spec/2b2-runtime-value.watsup', 7, 10))), [])), 376, p4specast.IterT(p4specast.VarT(p4specast.Id('val', p4specast.Region(p4specast.Position('spec/2e-runtime-env.watsup', 11, 26), p4specast.Position('spec/2e-runtime-env.watsup', 11, 29))), []), p4specast.Opt()))], 377, p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/2e-runtime-env.watsup', 11, 7), p4specast.Position('spec/2e-runtime-env.watsup', 11, 11))), [])), 429, p4specast.IterT(p4specast.VarT(p4specast.Id('styp', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 286, 54), p4specast.Position('spec/4a1-typing-context.watsup', 286, 58))), []), p4specast.Opt()))
    name = 'find_styp'
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(expected)

def test_text_exp():
    exp = p4specast.TextE('main')
    exp.typ = p4specast.TextT()
    ctx, value = interp.eval_exp(None, exp)
    expected = objects.TextV('main', typ=p4specast.TextT())
    assert value.eq(expected)

def test_upcast():
    typ = p4specast.VarT(p4specast.Id('typ', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 123, 19), p4specast.Position('spec/3-syntax-il.watsup', 123, 22))), [])
    value = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('IntT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 36, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 36, 8)))]]), [], -1, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 35, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 35, 13))), []))
    ctx = make_context()
    ctx, res = interp.upcast(ctx, typ, value)
    assert res.eq(value)

def test_concat_text():
    input_values = [objects.ListV([objects.TextV('CounterType', 254, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [])), objects.TextV('.', 7650, p4specast.TextT()), objects.TextV('packets_and_bytes', 257, p4specast.VarT(p4specast.Id('member', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))], 7651, p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.List()))]
    name = 'concat_text'
    expected = objects.TextV('CounterType.packets_and_bytes', 7689, p4specast.TextT())

    ctx = make_context()
    func = ctx.glbl.fenv[name]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(expected)

@pytest.mark.xfail(msg='missing builtin fresh_tid')
def test_conse_fresh_tids():
    name = 'fresh_tids'
    input_values = [objects.NumV.fromstr('1', 'Nat', 8286, p4specast.NumT(p4specast.NatT()))]
    res = objects.ListV([objects.TextV('FRESH__0', 8289, p4specast.VarT(p4specast.Id('tid', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))], 8295, p4specast.IterT(p4specast.VarT(p4specast.Id('tid', p4specast.Region(p4specast.Position('spec/2a-runtime-domain.watsup', 13, 19), p4specast.Position('spec/2a-runtime-domain.watsup', 13, 22))), []), p4specast.List()))
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    ctx, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)

def test_check_arity():
    name = 'check_arity'
    input_values = [objects.ListV([], 4811, p4specast.IterT(p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.Opt()), p4specast.List())), objects.ListV([], 4812, p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.List()))]
    res = objects.BoolV(True, 4819, p4specast.BoolT())
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)

    input_values = [objects.ListV([objects.OptV(None, 3943, p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.Opt()))], 3944, p4specast.IterT(p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.Opt()), p4specast.List())), objects.ListV([objects.TextV('p', 92, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), []))], 3945, p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 21, 7), p4specast.Position('spec/1a-syntax-el.watsup', 21, 9))), []), p4specast.List()))]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)


    res = objects.BoolV(False, 4803, p4specast.BoolT())
    name = 'check_arity_more'
    func = ctx.glbl.fenv[name]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)

def test_eval_num_expr():
    exp = p4specast.NumE.fromstr('0', 'Nat')
    exp.typ = p4specast.NumT(p4specast.NatT())
    _, value = interp.eval_exp(None, exp)
    assert value.eq(objects.NumV.fromstr('0', 'Nat'))

def test_rel_paramtype_wf():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))]]), [objects.ListV([], 34302, p4specast.IterT(p4specast.VarT(p4specast.Id('tid', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 139, 39), p4specast.Position('spec/4a1-typing-context.watsup', 139, 42))), []), p4specast.List()))], 34303, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [p4specast.VarT(p4specast.Id('tid', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 139, 39), p4specast.Position('spec/4a1-typing-context.watsup', 139, 42))), [])])), objects.CaseV(p4specast.MixOp([[], [], [], [], []]), [objects.TextV('rej', 338, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NO', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))]]), [], 339, p4specast.VarT(p4specast.Id('dir', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('BoolT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 33, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 33, 9)))]]), [], 33247, p4specast.VarT(p4specast.Id('primtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 28, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 28, 14))), [])), objects.OptV(None, 33267, p4specast.IterT(p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 81, 35), p4specast.Position('spec/3-syntax-il.watsup', 81, 41))), []), p4specast.Opt()))], 33268, p4specast.VarT(p4specast.Id('paramIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 81, 7), p4specast.Position('spec/3-syntax-il.watsup', 81, 14))), []))]
    name = 'ParamType_wf'
    ctx = make_context()
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
    assert values == []

def test_rel_paramtypes_wf():
    ctx = make_context()
    name = 'ParamTypes_wf'
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 17), p4specast.Position('spec/0-aux.watsup', 71, 18)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 22), p4specast.Position('spec/0-aux.watsup', 71, 23)))]]), [objects.ListV([], 135, p4specast.IterT(p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 73, 24), p4specast.Position('spec/0-aux.watsup', 73, 25))), []), p4specast.List()))], 136, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 71, 7), p4specast.Position('spec/0-aux.watsup', 71, 11))), [p4specast.VarT(p4specast.Id('K', p4specast.Region(p4specast.Position('spec/0-aux.watsup', 73, 24), p4specast.Position('spec/0-aux.watsup', 73, 25))), [])])), objects.ListV([], 160, p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 18, 9), p4specast.Position('spec/2c1-runtime-type.watsup', 18, 17))), []), p4specast.List()))]
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
    assert values == []

def test_rel_paramtypes_wf2():
    ctx = make_context()
    name = 'ParamTypes_wf'
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))], [p4specast.AtomT('}', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))]]), [objects.ListV([], 34302, p4specast.IterT(p4specast.VarT(p4specast.Id('tid', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 139, 39), p4specast.Position('spec/4a1-typing-context.watsup', 139, 42))), []), p4specast.List()))], 34303, p4specast.VarT(p4specast.Id('set', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [p4specast.VarT(p4specast.Id('tid', p4specast.Region(p4specast.Position('spec/4a1-typing-context.watsup', 139, 39), p4specast.Position('spec/4a1-typing-context.watsup', 139, 42))), [])])), objects.ListV([objects.CaseV(p4specast.MixOp([[], [], [], [], []]), [objects.TextV('rej', 338, p4specast.VarT(p4specast.Id('id', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NO', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0)))]]), [], 339, p4specast.VarT(p4specast.Id('dir', p4specast.Region(p4specast.Position('', 0, 0), p4specast.Position('', 0, 0))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('BoolT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 33, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 33, 9)))]]), [], 33247, p4specast.VarT(p4specast.Id('primtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 28, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 28, 14))), [])), objects.OptV(None, 33267, p4specast.IterT(p4specast.VarT(p4specast.Id('exprIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 81, 35), p4specast.Position('spec/3-syntax-il.watsup', 81, 41))), []), p4specast.Opt()))], 33268, p4specast.VarT(p4specast.Id('paramIL', p4specast.Region(p4specast.Position('spec/3-syntax-il.watsup', 81, 7), p4specast.Position('spec/3-syntax-il.watsup', 81, 14))), []))], 34310, p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 18, 9), p4specast.Position('spec/2c1-runtime-type.watsup', 18, 17))), []), p4specast.List()))]
    ctx = make_context()
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
    assert values == []

def test_type_alpha():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('StructT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 66, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 66, 11)))], [], []]), [objects.TextV('metadata', 501, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), [])), objects.ListV([], 88162, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('member', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 35, 7), p4specast.Position('spec/1a-syntax-el.watsup', 35, 13))), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region(p4specast.Position('spec/2c3-runtime-type-subst.watsup', 16, 29), p4specast.Position('spec/2c3-runtime-type-subst.watsup', 16, 32))), [])]), p4specast.List()))], 88163, p4specast.VarT(p4specast.Id('datatyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 59, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 59, 14))), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('StructT', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 66, 4), p4specast.Position('spec/2c1-runtime-type.watsup', 66, 11)))], [], []]), [objects.TextV('metadata', 501, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), [])), objects.ListV([], 88197, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('member', p4specast.Region(p4specast.Position('spec/1a-syntax-el.watsup', 35, 7), p4specast.Position('spec/1a-syntax-el.watsup', 35, 13))), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region(p4specast.Position('spec/2c3-runtime-type-subst.watsup', 16, 29), p4specast.Position('spec/2c3-runtime-type-subst.watsup', 16, 32))), [])]), p4specast.List()))], 88198, p4specast.VarT(p4specast.Id('datatyp', p4specast.Region(p4specast.Position('spec/2c1-runtime-type.watsup', 59, 7), p4specast.Position('spec/2c1-runtime-type.watsup', 59, 14))), []))]
    name = 'Type_alpha'
    ctx = make_context()
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
    assert values == []

def test_funcdef_wf():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{', p4specast.Region.line_span('spec/0-aux.watsup', 71, 17, 18))], [p4specast.AtomT('}', p4specast.Region.line_span('spec/0-aux.watsup', 71, 22, 23))]]), [objects.ListV([], 6524, p4specast.IterT(p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 73, 24, 25)), []), p4specast.List()))], 6525, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 73, 24, 25)), [])])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('PolyFD', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 142, 2, 8))], [p4specast.AtomT('->', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 142, 28, 30))], []]), [objects.TupleV([objects.ListV([], 6515, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())), objects.ListV([], 6516, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()))], 6517, p4specast.TupleT([p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()), p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('ExternFuncT', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 123, 4, 15))], [], []]), [objects.ListV([], 6518, p4specast.IterT(p4specast.VarT(p4specast.Id('paramIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 81, 7, 14)), []), p4specast.List())), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('VoidT', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 29, 4, 9))]]), [], 6496, p4specast.VarT(p4specast.Id('primtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 28, 7, 14)), []))], 6519, p4specast.VarT(p4specast.Id('functyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 121, 7, 14)), []))], 6520, p4specast.VarT(p4specast.Id('polyfuncdef', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 141, 7, 18)), []))]
    name = 'FuncDef_wf'
    ctx = make_context()
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
    assert values == []

def test_add_action():
    ctx = make_context()
    input_values = [objects.TupleV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT('CURRENT', p4specast.NO_REGION)], []]), [objects.TextV('Set_dmac', 14, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), []))], 15, p4specast.VarT(p4specast.Id('name', p4specast.NO_REGION), [])), objects.ListV([], 772, p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 18, 9, 17)), []), p4specast.List())), objects.ListV([], 773, p4specast.IterT(p4specast.VarT(p4specast.Id('argIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 99, 7, 12)), []), p4specast.List()))], 774, p4specast.TupleT([p4specast.VarT(p4specast.Id('name', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 27, 7, 11)), []), p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 18, 9, 17)), []), p4specast.List()), p4specast.IterT(p4specast.VarT(p4specast.Id('argIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 99, 7, 12)), []), p4specast.List())])), objects.StructV([(p4specast.AtomT('KEYS', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 28, 4, 8)), objects.ListV([], 559, p4specast.IterT(p4specast.VarT(p4specast.Id('key', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 28, 9, 12)), []), p4specast.List()))), (p4specast.AtomT('ACTIONS', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 29, 4, 11)), objects.ListV([], 560, p4specast.IterT(p4specast.VarT(p4specast.Id('action', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 29, 12, 18)), []), p4specast.List()))), (p4specast.AtomT('PRIORITIES', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 30, 4, 14)), objects.StructV([(p4specast.AtomT('VALUES', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 12, 4, 10)), objects.ListV([], 561, p4specast.IterT(p4specast.NumT(p4specast.IntT()), p4specast.List()))), (p4specast.AtomT('INIT', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 13, 4, 8)), objects.BoolV(False, 562, p4specast.BoolT())), (p4specast.AtomT('DELTA', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 14, 4, 9)), objects.NumV.fromstr('1', 'Int', 564, p4specast.NumT(p4specast.IntT()))), (p4specast.AtomT('LARGEST_WINS', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 15, 4, 16)), objects.BoolV(True, 565, p4specast.BoolT()))], 566, p4specast.VarT(p4specast.Id('priority', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 46, 17, 25)), []))), (p4specast.AtomT('ENTRIES', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 31, 4, 11)), objects.StructV([(p4specast.AtomT('SIZE', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 18, 4, 8)), objects.NumV.fromstr('0', 'Int', 568, p4specast.NumT(p4specast.IntT()))), (p4specast.AtomT('CONST', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 19, 4, 9)), objects.BoolV(True, 569, p4specast.BoolT()))], 570, p4specast.VarT(p4specast.Id('entry', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 53, 17, 22)), []))), (p4specast.AtomT('MODE', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 32, 4, 8)), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NOPRI', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 6, 4, 9))]]), [], 571, p4specast.VarT(p4specast.Id('mode', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 5, 7, 11)), [])))], 572, p4specast.VarT(p4specast.Id('tblctx', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 58, 21, 27)), []))]
    name = 'add_action'
    res = objects.StructV([(p4specast.AtomT('KEYS', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 28, 4, 8)), objects.ListV([], 559, p4specast.IterT(p4specast.VarT(p4specast.Id('key', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 28, 9, 12)), []), p4specast.List()))), (p4specast.AtomT('ACTIONS', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 29, 4, 11)), objects.ListV([objects.TupleV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT('CURRENT', p4specast.NO_REGION)], []]), [objects.TextV('Set_dmac', 14, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), []))], 15, p4specast.VarT(p4specast.Id('name', p4specast.NO_REGION), [])), objects.ListV([], 772, p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 18, 9, 17)), []), p4specast.List())), objects.ListV([], 773, p4specast.IterT(p4specast.VarT(p4specast.Id('argIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 99, 7, 12)), []), p4specast.List()))], 774, p4specast.TupleT([p4specast.VarT(p4specast.Id('name', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 27, 7, 11)), []), p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 18, 9, 17)), []), p4specast.List()), p4specast.IterT(p4specast.VarT(p4specast.Id('argIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 99, 7, 12)), []), p4specast.List())]))], 776, p4specast.IterT(p4specast.VarT(p4specast.Id('action', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 29, 12, 18)), []), p4specast.List()))), (p4specast.AtomT('PRIORITIES', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 30, 4, 14)), objects.StructV([(p4specast.AtomT('VALUES', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 12, 4, 10)), objects.ListV([], 561, p4specast.IterT(p4specast.NumT(p4specast.IntT()), p4specast.List()))), (p4specast.AtomT('INIT', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 13, 4, 8)), objects.BoolV(False, 562, p4specast.BoolT())), (p4specast.AtomT('DELTA', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 14, 4, 9)), objects.NumV.fromstr('1', 'Int', 564, p4specast.NumT(p4specast.IntT()))), (p4specast.AtomT('LARGEST_WINS', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 15, 4, 16)), objects.BoolV(True, 565, p4specast.BoolT()))], 566, p4specast.VarT(p4specast.Id('priority', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 46, 17, 25)), []))), (p4specast.AtomT('ENTRIES', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 31, 4, 11)), objects.StructV([(p4specast.AtomT('SIZE', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 18, 4, 8)), objects.NumV.fromstr('0', 'Int', 568, p4specast.NumT(p4specast.IntT()))), (p4specast.AtomT('CONST', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 19, 4, 9)), objects.BoolV(True, 569, p4specast.BoolT()))], 570, p4specast.VarT(p4specast.Id('entry', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 53, 17, 22)), []))), (p4specast.AtomT('MODE', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 32, 4, 8)), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('NOPRI', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 6, 4, 9))]]), [], 571, p4specast.VarT(p4specast.Id('mode', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 5, 7, 11)), [])))], 777, p4specast.VarT(p4specast.Id('tblctx', p4specast.Region.line_span('spec/4a2-typing-tblctx.watsup', 27, 7, 13)), []))
    func = ctx.glbl.fenv[name]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)

@pytest.mark.skip(msg='broken in a weird way')
def test_find_matching_func():
    input_values = [objects.TextV('mark_to_pass', 623, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), [])), objects.ListV([], 51546, p4specast.IterT(p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 21, 7, 9)), []), p4specast.Opt()), p4specast.List())), objects.ListV([], 51547, p4specast.IterT(p4specast.VarT(p4specast.Id('id', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 21, 7, 9)), []), p4specast.List())), objects.CaseV(p4specast.MixOp([[], [], []]), [objects.TextV('NoAction', 108, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), [])), objects.ListV([], 4243, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('id', p4specast.Region.line_span('spec/2a-runtime-domain.watsup', 35, 24, 26)), []), p4specast.BoolT()]), p4specast.List()))], 4244, p4specast.VarT(p4specast.Id('fid', p4specast.Region.line_span('spec/2a-runtime-domain.watsup', 29, 7, 10)), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('MonoFD', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 139, 2, 8))], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('ActionT', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 122, 4, 11))], []]), [objects.ListV([], 4274, p4specast.IterT(p4specast.VarT(p4specast.Id('paramIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 81, 7, 14)), []), p4specast.List()))], 4275, p4specast.VarT(p4specast.Id('functyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 121, 7, 14)), []))], 4276, p4specast.VarT(p4specast.Id('monofuncdef', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 138, 7, 18)), []))]
    name = 'find_matching_func'
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)

@pytest.mark.xfail(msg='builtin update_map not implemented')
def test_merge_cstr():
    name = "merge_cstr'"
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([objects.CaseV(p4specast.MixOp([[], [p4specast.AtomT.line_span('->', 'spec/0-aux.watsup', 103, 22, 24)], []]), [objects.TextV('FRESH__79', 35833, p4specast.VarT(p4specast.Id('tid', p4specast.NO_REGION), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('UNKNOWN', 'spec/4h-typing-call.watsup', 184, 4, 11)]]), [], 45799, p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 182, 7, 14)), []))], 45800, p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 103, 7, 12)), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 188, 28, 31)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 188, 33, 40)), [])]))], 45801, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 188, 28, 31)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 188, 33, 40)), [])]), p4specast.List()))], 45802, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 188, 28, 31)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 188, 33, 40)), [])])])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{')], [p4specast.AtomT('}')]]), [objects.ListV([objects.CaseV(p4specast.MixOp([[], [p4specast.AtomT('->')], []]), [objects.TextV('FRESH__79', 35833, p4specast.VarT(p4specast.Id('tid', p4specast.NO_REGION), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('KNOWN', 'spec/4h-typing-call.watsup', 183, 4, 9)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('SpecT', 'spec/2c1-runtime-type.watsup', 50, 4, 9)], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('PolyD', 'spec/2c1-runtime-type.watsup', 107, 2, 7)], [p4specast.AtomT.line_span('->', 'spec/2c1-runtime-type.watsup', 107, 27, 29)], []]), [objects.TupleV([objects.ListV([], 49732, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())), objects.ListV([], 49733, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()))], 49734, p4specast.TupleT([p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()), p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('StructT', 'spec/2c1-runtime-type.watsup', 66, 4, 11)], [], []]), [objects.TextV('Headers_t', 290, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), [])), objects.ListV([], 49730, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('member', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 35, 7, 13)), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c3-runtime-type-subst.watsup', 16, 29, 32)), [])]), p4specast.List()))], 49731, p4specast.VarT(p4specast.Id('datatyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 59, 7, 14)), []))], 49735, p4specast.VarT(p4specast.Id('polytypdef', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 106, 7, 17)), [])), objects.ListV([], 49738, p4specast.IterT(p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 5, 7, 10)), []), p4specast.List()))], 49739, p4specast.VarT(p4specast.Id('abstyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 48, 7, 13)), []))], 49818, p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 182, 7, 14)), []))], 49820, p4specast.VarT(p4specast.Id('pair', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 211, 51, 54)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 211, 56, 63)), [])]))], 49819, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 211, 51, 54)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 211, 56, 63)), [])]), p4specast.List()))], 49821, p4specast.VarT(p4specast.Id('map', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 211, 51, 54)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 211, 56, 63)), [])])), objects.ListV([objects.TextV('FRESH__79', 35833, p4specast.VarT(p4specast.Id('tid', p4specast.NO_REGION), []))], 49845, p4specast.IterT(p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/2a-runtime-domain.watsup', 10, 7, 10)), []), p4specast.List())), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 49846, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 204, 65, 68)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 204, 70, 77)), [])]), p4specast.List()))], 49847, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 204, 65, 68)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 204, 70, 77)), [])])]))]
    res = objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{')], [p4specast.AtomT('}')]]), [objects.ListV([objects.CaseV(p4specast.MixOp([[], [p4specast.AtomT('->')], []]), [objects.TextV('FRESH__79', 35833, p4specast.VarT(p4specast.Id('tid', p4specast.NO_REGION), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('KNOWN', 'spec/4h-typing-call.watsup', 183, 4, 9)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('SpecT', 'spec/2c1-runtime-type.watsup', 50, 4, 9)], [], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('PolyD', 'spec/2c1-runtime-type.watsup', 107, 2, 7)], [p4specast.AtomT.line_span('->', 'spec/2c1-runtime-type.watsup', 107, 27, 29)], []]), [objects.TupleV([objects.ListV([], 49732, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())), objects.ListV([], 49733, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()))], 49734, p4specast.TupleT([p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()), p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('StructT', 'spec/2c1-runtime-type.watsup', 66, 4, 11)], [], []]), [objects.TextV('Headers_t', 290, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), [])), objects.ListV([], 49730, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('member', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 35, 7, 13)), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c3-runtime-type-subst.watsup', 16, 29, 32)), [])]), p4specast.List()))], 49731, p4specast.VarT(p4specast.Id('datatyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 59, 7, 14)), []))], 49735, p4specast.VarT(p4specast.Id('polytypdef', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 106, 7, 17)), [])), objects.ListV([], 49738, p4specast.IterT(p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 5, 7, 10)), []), p4specast.List()))], 49739, p4specast.VarT(p4specast.Id('abstyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 48, 7, 13)), []))], 49871, p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 182, 7, 14)), []))], 49873, p4specast.VarT(p4specast.Id('pair', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 297, 28, 31)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 297, 33, 40)), [])]))], 49872, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 297, 28, 31)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 297, 33, 40)), [])]), p4specast.List()))], 49874, p4specast.VarT(p4specast.Id('map', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4h-typing-call.watsup', 297, 28, 31)), []), p4specast.VarT(p4specast.Id('typcstr', p4specast.Region.line_span('spec/4h-typing-call.watsup', 297, 33, 40)), [])]))
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(res)

def test_targs_type_wf():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{')], [p4specast.AtomT('}')]]), [objects.ListV([objects.TextV('T', 13, p4specast.VarT(p4specast.Id('tparam', p4specast.NO_REGION), []))], 1310, p4specast.IterT(p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4g-typing-decl.watsup', 20, 28, 31)), []), p4specast.List()))], 1311, p4specast.VarT(p4specast.Id('set', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/4g-typing-decl.watsup', 20, 28, 31)), [])])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('VarT', 'spec/2c1-runtime-type.watsup', 49, 4, 8)], []]), [objects.TextV('T', 13, p4specast.VarT(p4specast.Id('tparam', p4specast.NO_REGION), []))], 1194, p4specast.VarT(p4specast.Id('abstyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 48, 7, 13)), []))]
    name = 'Type_wf'
    ctx = make_context()
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
    assert values == []

def test_targs_type_wf2():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 1376, p4specast.IterT(p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 116, 13, 14)), []), p4specast.List()))], 1377, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 113, 36, 37)), [])])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('TableStructT', 'spec/2c1-runtime-type.watsup', 94, 4, 16)], [], []]), [objects.TextV('apply_result(t)', 35631, p4specast.TextT()), objects.ListV([objects.TupleV([objects.TextV('hit', 35632, p4specast.TextT()), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('BoolT', 'spec/2c1-runtime-type.watsup', 33, 4, 9)]]), [], 35633, p4specast.VarT(p4specast.Id('primtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 28, 7, 14)), []))], 35634, p4specast.TupleT([p4specast.VarT(p4specast.Id('member', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 94, 21, 27)), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 94, 29, 32)), [])])), objects.TupleV([objects.TextV('miss', 35635, p4specast.TextT()), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('BoolT', 'spec/2c1-runtime-type.watsup', 33, 4, 9)]]), [], 35636, p4specast.VarT(p4specast.Id('primtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 28, 7, 14)), []))], 35637, p4specast.TupleT([p4specast.VarT(p4specast.Id('member', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 94, 21, 27)), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 94, 29, 32)), [])])), objects.TupleV([objects.TextV('action_run', 35638, p4specast.TextT()), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('TableEnumT', 'spec/2c1-runtime-type.watsup', 93, 4, 14)], [], []]), [objects.TextV('action_list(t)', 35485, p4specast.TextT()), objects.ListV([objects.TextV('Reject', 405, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), []))], 35495, p4specast.IterT(p4specast.VarT(p4specast.Id('member', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 35, 7, 13)), []), p4specast.List()))], 35496, p4specast.VarT(p4specast.Id('synthtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 84, 7, 15)), []))], 35639, p4specast.TupleT([p4specast.TextT(), p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 5, 7, 10)), [])]))], 35640, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('member', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 94, 21, 27)), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 94, 29, 32)), [])]), p4specast.List()))], 35641, p4specast.VarT(p4specast.Id('synthtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 84, 7, 15)), []))]
    name = 'Type_wf'
    ctx = make_context()
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
    assert values == []

def test_is_deft():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('VarT', 'spec/2c1-runtime-type.watsup', 49, 4, 8)], []]), [objects.TextV('T', 13, p4specast.VarT(p4specast.Id('tparam', p4specast.NO_REGION), []))], 3024, p4specast.VarT(p4specast.Id('abstyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 48, 7, 13)), []))]
    name = 'is_deft'
    ctx = make_context()
    func = ctx.glbl.fenv[name]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.value == False

def test_ParamTypes_wf():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{')], [p4specast.AtomT('}')]]), [objects.ListV([objects.TextV('T', 13, p4specast.VarT(p4specast.Id('tparam', p4specast.NO_REGION), []))], 3254, p4specast.IterT(p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/2c6-runtime-type-wellformed.watsup', 526, 29, 32)), []), p4specast.List()))], 3255, p4specast.VarT(p4specast.Id('set', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/2c6-runtime-type-wellformed.watsup', 526, 29, 32)), [])])), objects.ListV([objects.CaseV(p4specast.MixOp([[], [], [], [], []]), [objects.TextV('hdr', 15, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('OUT')]]), [], 16, p4specast.VarT(p4specast.Id('dir', p4specast.NO_REGION), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('VarT', 'spec/2c1-runtime-type.watsup', 49, 4, 8)], []]), [objects.TextV('T', 13, p4specast.VarT(p4specast.Id('tparam', p4specast.NO_REGION), []))], 3024, p4specast.VarT(p4specast.Id('abstyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 48, 7, 13)), [])), objects.OptV(None, 3151, p4specast.IterT(p4specast.VarT(p4specast.Id('exprIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 81, 35, 41)), []), p4specast.Opt()))], 3152, p4specast.VarT(p4specast.Id('paramIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 81, 7, 14)), []))], 3266, p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 18, 9, 17)), []), p4specast.List()))]
    name = 'ParamTypes_wf'
    ctx = make_context()
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
    assert values == []

@pytest.mark.xfail(msg='maps_ad_map should be implemented')
def test_Decl_ok():
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('GLOBAL', 'spec/4a1-typing-context.watsup', 5, 16, 22)]]), [], 2252, p4specast.VarT(p4specast.Id('cursor', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 5, 7, 13)), [])), objects.StructV([(p4specast.AtomT.line_span('GLOBAL', 'spec/4a1-typing-context.watsup', 56, 4, 10), objects.StructV([(p4specast.AtomT.line_span('CDENV', 'spec/4a1-typing-context.watsup', 16, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 2225, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 2226, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('TDENV', 'spec/4a1-typing-context.watsup', 17, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 2227, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 2228, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('FDENV', 'spec/4a1-typing-context.watsup', 18, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 2229, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 2230, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('FRAME', 'spec/4a1-typing-context.watsup', 19, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 2231, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 2232, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])])))], 2233, p4specast.VarT(p4specast.Id('glayer', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 15, 7, 13)), []))), (p4specast.AtomT.line_span('BLOCK', 'spec/4a1-typing-context.watsup', 57, 4, 9), objects.StructV([(p4specast.AtomT.line_span('ID', 'spec/4a1-typing-context.watsup', 26, 4, 6), objects.TextV('', 2234, p4specast.TextT())), (p4specast.AtomT.line_span('KIND', 'spec/4a1-typing-context.watsup', 27, 4, 8), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('EMPTY', 'spec/4a1-typing-context.watsup', 23, 15, 20)]]), [], 2235, p4specast.VarT(p4specast.Id('bkind', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 23, 7, 12)), []))), (p4specast.AtomT.line_span('TDENV', 'spec/4a1-typing-context.watsup', 28, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 2236, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 2237, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('FDENV', 'spec/4a1-typing-context.watsup', 29, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 2238, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 2239, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('FRAME', 'spec/4a1-typing-context.watsup', 30, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 2240, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 2241, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])])))], 2242, p4specast.VarT(p4specast.Id('blayer', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 25, 7, 13)), []))), (p4specast.AtomT.line_span('LOCAL', 'spec/4a1-typing-context.watsup', 58, 4, 9), objects.StructV([(p4specast.AtomT.line_span('ID', 'spec/4a1-typing-context.watsup', 46, 4, 6), objects.TextV('', 2243, p4specast.TextT())), (p4specast.AtomT.line_span('KIND', 'spec/4a1-typing-context.watsup', 47, 4, 8), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('EMPTY', 'spec/4a1-typing-context.watsup', 35, 4, 9)]]), [], 2244, p4specast.VarT(p4specast.Id('lkind', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 34, 7, 12)), []))), (p4specast.AtomT.line_span('TDENV', 'spec/4a1-typing-context.watsup', 48, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 2245, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 2246, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('FRAMES', 'spec/4a1-typing-context.watsup', 49, 4, 10), objects.ListV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 2247, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 2248, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))], 2249, p4specast.IterT(p4specast.VarT(p4specast.Id('map', p4specast.Region.line_span('spec/0-aux.watsup', 108, 23, 27)), [p4specast.VarT(p4specast.Id('id', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 84, 29, 31)), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 84, 33, 37)), [])]), p4specast.List())))], 2250, p4specast.VarT(p4specast.Id('llayer', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 45, 7, 13)), [])))], 2251, p4specast.VarT(p4specast.Id('context', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 60, 8, 15)), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('ErrD')], []]), [objects.ListV([objects.TextV('NoError', 0, p4specast.VarT(p4specast.Id('member', p4specast.NO_REGION), [])), objects.TextV('PacketTooShort', 1, p4specast.VarT(p4specast.Id('member', p4specast.NO_REGION), [])), objects.TextV('NoMatch', 2, p4specast.VarT(p4specast.Id('member', p4specast.NO_REGION), [])), objects.TextV('StackOutOfBounds', 3, p4specast.VarT(p4specast.Id('member', p4specast.NO_REGION), [])), objects.TextV('HeaderTooShort', 4, p4specast.VarT(p4specast.Id('member', p4specast.NO_REGION), [])), objects.TextV('ParserTimeout', 5, p4specast.VarT(p4specast.Id('member', p4specast.NO_REGION), [])), objects.TextV('ParserInvalidArgument', 6, p4specast.VarT(p4specast.Id('member', p4specast.NO_REGION), []))], 7, p4specast.IterT(p4specast.VarT(p4specast.Id('member', p4specast.NO_REGION), []), p4specast.List()))], 8, p4specast.VarT(p4specast.Id('decl', p4specast.NO_REGION), []))]
    name = 'Decl_ok'
    ctx = make_context()
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)


def test_call_default_action_ok():
    name = 'Call_default_action_ok'
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('LOCAL', 'spec/4a1-typing-context.watsup', 5, 33, 38)]]), [], 558, p4specast.VarT(p4specast.Id('cursor', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 5, 7, 13)), [])), objects.StructV([(p4specast.AtomT.line_span('GLOBAL', 'spec/4a1-typing-context.watsup', 56, 4, 10), objects.StructV([(p4specast.AtomT.line_span('CDENV', 'spec/4a1-typing-context.watsup', 16, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 39, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 40, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('TDENV', 'spec/4a1-typing-context.watsup', 17, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 41, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 42, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('FDENV', 'spec/4a1-typing-context.watsup', 18, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 43, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 44, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('FRAME', 'spec/4a1-typing-context.watsup', 19, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 45, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 46, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])])))], 47, p4specast.VarT(p4specast.Id('glayer', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 15, 7, 13)), []))), (p4specast.AtomT.line_span('BLOCK', 'spec/4a1-typing-context.watsup', 57, 4, 9), objects.StructV([(p4specast.AtomT.line_span('ID', 'spec/4a1-typing-context.watsup', 26, 4, 6), objects.TextV('', 48, p4specast.TextT())), (p4specast.AtomT.line_span('KIND', 'spec/4a1-typing-context.watsup', 27, 4, 8), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('CONTROL', 'spec/4a1-typing-context.watsup', 23, 41, 48)]]), [], 114, p4specast.VarT(p4specast.Id('bkind', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 23, 7, 12)), []))), (p4specast.AtomT.line_span('TDENV', 'spec/4a1-typing-context.watsup', 28, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 50, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 51, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('FDENV', 'spec/4a1-typing-context.watsup', 29, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{')], [p4specast.AtomT('}')]]), [objects.ListV([objects.CaseV(p4specast.MixOp([[], [p4specast.AtomT('->')], []]), [objects.CaseV(p4specast.MixOp([[], [], []]), [objects.TextV('Set_dmac', 3, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), [])), objects.ListV([], 215, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('id', p4specast.Region.line_span('spec/2a-runtime-domain.watsup', 35, 24, 26)), []), p4specast.BoolT()]), p4specast.List()))], 216, p4specast.VarT(p4specast.Id('fid', p4specast.Region.line_span('spec/2a-runtime-domain.watsup', 29, 7, 10)), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('MonoFD', 'spec/2c1-runtime-type.watsup', 139, 2, 8)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('ActionT', 'spec/2c1-runtime-type.watsup', 122, 4, 11)], []]), [objects.ListV([], 246, p4specast.IterT(p4specast.VarT(p4specast.Id('paramIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 81, 7, 14)), []), p4specast.List()))], 247, p4specast.VarT(p4specast.Id('functyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 121, 7, 14)), []))], 248, p4specast.VarT(p4specast.Id('monofuncdef', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 138, 7, 18)), []))], 457, p4specast.VarT(p4specast.Id('pair', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('fid', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 265, 25, 28)), []), p4specast.VarT(p4specast.Id('funcdef', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 265, 30, 37)), [])])), objects.CaseV(p4specast.MixOp([[], [p4specast.AtomT('->')], []]), [objects.CaseV(p4specast.MixOp([[], [], []]), [objects.TextV('drop', 8, p4specast.VarT(p4specast.Id('id', p4specast.NO_REGION), [])), objects.ListV([], 356, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('id', p4specast.Region.line_span('spec/2a-runtime-domain.watsup', 35, 24, 26)), []), p4specast.BoolT()]), p4specast.List()))], 357, p4specast.VarT(p4specast.Id('fid', p4specast.Region.line_span('spec/2a-runtime-domain.watsup', 29, 7, 10)), [])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('MonoFD', 'spec/2c1-runtime-type.watsup', 139, 2, 8)], []]), [objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('ActionT', 'spec/2c1-runtime-type.watsup', 122, 4, 11)], []]), [objects.ListV([], 387, p4specast.IterT(p4specast.VarT(p4specast.Id('paramIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 81, 7, 14)), []), p4specast.List()))], 388, p4specast.VarT(p4specast.Id('functyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 121, 7, 14)), []))], 389, p4specast.VarT(p4specast.Id('monofuncdef', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 138, 7, 18)), []))], 458, p4specast.VarT(p4specast.Id('pair', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('fid', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 265, 25, 28)), []), p4specast.VarT(p4specast.Id('funcdef', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 265, 30, 37)), [])]))], 456, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('fid', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 265, 25, 28)), []), p4specast.VarT(p4specast.Id('funcdef', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 265, 30, 37)), [])]), p4specast.List()))], 459, p4specast.VarT(p4specast.Id('map', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('fid', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 265, 25, 28)), []), p4specast.VarT(p4specast.Id('funcdef', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 265, 30, 37)), [])]))), (p4specast.AtomT.line_span('FRAME', 'spec/4a1-typing-context.watsup', 30, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 54, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 55, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])])))], 460, p4specast.VarT(p4specast.Id('blayer', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 57, 10, 16)), []))), (p4specast.AtomT.line_span('LOCAL', 'spec/4a1-typing-context.watsup', 58, 4, 9), objects.StructV([(p4specast.AtomT.line_span('ID', 'spec/4a1-typing-context.watsup', 46, 4, 6), objects.TextV('', 57, p4specast.TextT())), (p4specast.AtomT.line_span('KIND', 'spec/4a1-typing-context.watsup', 47, 4, 8), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('TABLEAPPLYMETHOD', 'spec/4a1-typing-context.watsup', 43, 4, 20)]]), [], 555, p4specast.VarT(p4specast.Id('lkind', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 34, 7, 12)), []))), (p4specast.AtomT.line_span('TDENV', 'spec/4a1-typing-context.watsup', 48, 4, 9), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 59, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 60, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))), (p4specast.AtomT.line_span('FRAMES', 'spec/4a1-typing-context.watsup', 49, 4, 10), objects.ListV([objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('{', 'spec/0-aux.watsup', 71, 17, 18)], [p4specast.AtomT.line_span('}', 'spec/0-aux.watsup', 71, 22, 23)]]), [objects.ListV([], 61, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])]), p4specast.List()))], 62, p4specast.VarT(p4specast.Id('set', p4specast.Region.line_span('spec/0-aux.watsup', 71, 7, 11)), [p4specast.VarT(p4specast.Id('pair', p4specast.Region.line_span('spec/0-aux.watsup', 106, 24, 29)), [p4specast.VarT(p4specast.Id('K', p4specast.Region.line_span('spec/0-aux.watsup', 108, 27, 28)), []), p4specast.VarT(p4specast.Id('V', p4specast.Region.line_span('spec/0-aux.watsup', 108, 30, 31)), [])])]))], 63, p4specast.IterT(p4specast.VarT(p4specast.Id('map', p4specast.Region.line_span('spec/0-aux.watsup', 108, 23, 27)), [p4specast.VarT(p4specast.Id('id', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 84, 29, 31)), []), p4specast.VarT(p4specast.Id('styp', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 84, 33, 37)), [])]), p4specast.List())))], 556, p4specast.VarT(p4specast.Id('llayer', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 58, 10, 16)), [])))], 557, p4specast.VarT(p4specast.Id('context', p4specast.Region.line_span('spec/4a1-typing-context.watsup', 60, 8, 15)), [])), objects.ListV([], 1061, p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 18, 9, 17)), []), p4specast.List())), objects.ListV([], 1062, p4specast.IterT(p4specast.TupleT([p4specast.VarT(p4specast.Id('argIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 99, 7, 12)), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 5, 7, 10)), [])]), p4specast.List())), objects.ListV([], 1063, p4specast.IterT(p4specast.VarT(p4specast.Id('argIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 99, 7, 12)), []), p4specast.List()))]
    expected = objects.ListV([], 1086, p4specast.IterT(p4specast.VarT(p4specast.Id('argIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 99, 7, 12)), []), p4specast.List()))
    ctx = make_context()
    _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
    value, = values
    assert value.eq(expected)

@pytest.mark.xfail(msg='missing builtin adds_map')
def test_slice_subst_funcdef():
    name = 'subst_funcdef'
    input_values = [objects.CaseV(p4specast.MixOp([[p4specast.AtomT('{')], [p4specast.AtomT('}')]]), [objects.ListV([], 29319, p4specast.IterT(p4specast.VarT(p4specast.Id('pair', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/2c3-runtime-type-subst.watsup', 237, 28, 31)), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c3-runtime-type-subst.watsup', 237, 33, 36)), [])]), p4specast.List()))], 29320, p4specast.VarT(p4specast.Id('map', p4specast.NO_REGION), [p4specast.VarT(p4specast.Id('tid', p4specast.Region.line_span('spec/2c3-runtime-type-subst.watsup', 237, 28, 31)), []), p4specast.VarT(p4specast.Id('typ', p4specast.Region.line_span('spec/2c3-runtime-type-subst.watsup', 237, 33, 36)), [])])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('PolyFD', 'spec/2c1-runtime-type.watsup', 142, 2, 8)], [p4specast.AtomT.line_span('->', 'spec/2c1-runtime-type.watsup', 142, 28, 30)], []]), [objects.TupleV([objects.ListV([], 2728, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())), objects.ListV([], 2729, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()))], 2730, p4specast.TupleT([p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()), p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('ExternMethodT', 'spec/2c1-runtime-type.watsup', 126, 4, 17)], [], []]), [objects.ListV([], 2731, p4specast.IterT(p4specast.VarT(p4specast.Id('paramIL', p4specast.Region.line_span('spec/3-syntax-il.watsup', 81, 7, 14)), []), p4specast.List())), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('FBitT', 'spec/2c1-runtime-type.watsup', 38, 4, 9)], []]), [objects.NumV.fromstr('32', 'Nat', 2704, p4specast.NumT(p4specast.NatT()))], 2705, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 35, 7, 13)), []))], 2732, p4specast.VarT(p4specast.Id('functyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 121, 7, 14)), []))], 2733, p4specast.VarT(p4specast.Id('polyfuncdef', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 141, 7, 18)), []))]
    expected = objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('PolyFD', 'spec/2c1-runtime-type.watsup', 142, 2, 8)], [p4specast.AtomT.line_span('->', 'spec/2c1-runtime-type.watsup', 142, 28, 30)], []]), [objects.TupleV([objects.ListV([], 29779, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())), objects.ListV([], 29780, p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()))], 29781, p4specast.TupleT([p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List()), p4specast.IterT(p4specast.VarT(p4specast.Id('tparam', p4specast.Region.line_span('spec/1a-syntax-el.watsup', 123, 7, 13)), []), p4specast.List())])), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('ExternMethodT', 'spec/2c1-runtime-type.watsup', 126, 4, 17)], [], []]), [objects.ListV([], 29771, p4specast.IterT(p4specast.VarT(p4specast.Id('paramtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 18, 9, 17)), []), p4specast.List())), objects.CaseV(p4specast.MixOp([[p4specast.AtomT.line_span('FBitT', 'spec/2c1-runtime-type.watsup', 38, 4, 9)], []]), [objects.NumV.fromstr('32', 'Nat', 2704, p4specast.NumT(p4specast.NatT()))], 2705, p4specast.VarT(p4specast.Id('numtyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 35, 7, 13)), []))], 29778, p4specast.VarT(p4specast.Id('functyp', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 121, 7, 14)), []))], 29782, p4specast.VarT(p4specast.Id('polyfuncdef', p4specast.Region.line_span('spec/2c1-runtime-type.watsup', 141, 7, 18)), []))

    ctx = make_context()
    func = ctx.glbl.fenv[name]
    _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
    assert value.eq(expected)

def iter_all(fn):
    with open(fn, 'r') as f:
        for line in f:
            if not line.startswith('{'):
                continue
            callspec = rpyjson.loads(line)
            what = callspec.get_dict_value('calltype').value_string()
            args = callspec.get_dict_value('inputs')
            input_values = [objects.BaseV.fromjson(arg) for arg in args]
            if what == 'function':
                res_value = objects.BaseV.fromjson(callspec.get_dict_value('result'))
                yield "function", callspec.get_dict_value('name').value_string(), input_values, res_value
            elif what == 'relation':
                res_values = [objects.BaseV.fromjson(rv) for rv in callspec.get_dict_value('results').value_array()]
                yield "relation", callspec.get_dict_value('name').value_string(), input_values, res_values
            else:
                assert 0

def test_all():
    # load test cases from line-based json file
    # check if file exists
    if not os.path.exists(os.path.join(os.path.dirname(__file__), 'interp_tests.json')):
        assert False
    ctx = make_context()
    passed = 0
    failed = 0
    error = 0
    for calltype, name, input_values, res in iter_all(os.path.join(os.path.dirname(__file__), 'interp_tests.json')):
        if calltype == "function":
            if name not in ctx.glbl.fenv:
                continue
            func = ctx.glbl.fenv[name]
            try:
                _, value = interp.invoke_func_def_attempt_clauses(ctx, func, input_values)
                if not value.eq(res):
                    failed += 1
                    print("Function test failed:", name, value, res)
                else:
                    passed += 1
                    print("Function test passed:", name)
            except Exception as e:
                #import pdb; pdb.xpm()
                error += 1
                print("Function test exception:", name, e)
                continue
        if calltype == "relation":
            try:
                _, values = interp.invoke_rel(ctx, p4specast.AtomT(name, None), input_values)
                if len(values) != len(res):
                    failed += 1
                    print("Relation test wrong number of results", name, len(values), len(res))
                else:
                    for i, resval in enumerate(values):
                        resval_exp = res[i]
                        if not resval.eq(resval_exp):
                            failed += 1
                            print("Relation test failed:", name, resval, resval_exp)
                        else:
                            passed += 1
                            print("Relation test passed:", name)
            except Exception as e:
                #import pdb; pdb.xpm()
                error += 1
                print("Relation test exception:", name, e)
                continue
    print("PASSED:", passed)
    print("FAILED", failed)
    print("ERROR ", error)
